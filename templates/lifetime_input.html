<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í‰ìƒìš´ì„¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background: linear-gradient(180deg, #f8f4ff 0%, #f0e8ff 100%); -webkit-tap-highlight-color: transparent; min-height: 100vh; }
        .input-box { border: 1.5px solid #dcdcdc; border-radius: 14px; padding: 12px; font-size: 16px; color: #333; transition: all 0.2s; background: white; }
        .input-box:focus { border-color: #8b5cf6; outline: none; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1); }
        .toggle-btn { display: flex; align-items: center; gap: 8px; cursor: pointer; color: #444; font-size: 16px; user-select: none; padding: 4px 0; }
        .circle { width: 22px; height: 22px; border: 1.5px solid #dcdcdc; border-radius: 50%; position: relative; transition: all 0.2s; background: white; flex-shrink: 0; }
        .toggle-btn.active .circle { border-color: #8b5cf6; background-color: #8b5cf6; }
        .toggle-btn.active .circle::after { content: ''; position: absolute; width: 8px; height: 8px; background: white; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        #citySheet { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #citySheet.show { transform: translateY(0); }
        .sheet-overlay { opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .sheet-overlay.show { opacity: 1; pointer-events: auto; }
        .fortune-icon { font-size: 48px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .gradient-btn { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); }
        .gradient-btn:hover { background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%); }
    </style>
</head>
<body class="flex flex-col items-center p-4">
    {% if error %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 w-full max-w-md" role="alert">
        <strong class="font-bold">ì—ëŸ¬ ë°œìƒ:</strong>
        <span class="block sm:inline">{{ error }}</span>
    </div>
    {% endif %}

    <form id="lifetimeForm" action="/lifetime_web" method="POST" class="w-full max-w-md bg-white rounded-[32px] shadow-lg p-7 space-y-7 mt-4 border border-purple-100">
        <div class="text-center mb-4">
            <div class="fortune-icon mb-2">ğŸŒŸ</div>
            <h1 class="font-bold text-[22px] text-gray-800">í‰ìƒìš´ì„¸</h1>
            <p class="text-sm text-gray-400 mt-1">AIê°€ ë¶„ì„í•˜ëŠ” ë‚˜ì˜ ì¸ìƒ ì´ìš´</p>
        </div>

        <div class="space-y-3">
            <label class="font-bold text-[17px] text-[#333]">ì´ë¦„</label>
            <input type="text" name="name" id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" class="w-full border-0 border-b border-gray-200 py-3 text-[16px] focus:border-purple-400 outline-none transition-colors bg-transparent">
        </div>

        <div class="space-y-3">
            <label class="font-bold text-[17px] text-[#333]">ì„±ë³„</label>
            <input type="hidden" name="gender" id="hiddenGender" value="F">
            <div class="flex gap-2">
                <button type="button" onclick="setGender('F')" id="btnF" class="flex-1 py-3.5 rounded-2xl border-[1.5px] border-purple-400 font-bold text-[16px] bg-purple-50 text-purple-600 transition-all">ì—¬ì</button>
                <button type="button" onclick="setGender('M')" id="btnM" class="flex-1 py-3.5 rounded-2xl border border-gray-200 text-gray-400 text-[16px] transition-all">ë‚¨ì</button>
            </div>
        </div>

        <div class="space-y-4">
            <label class="font-bold text-[17px] text-[#333]">ìƒë…„ì›”ì¼ì‹œ</label>
            <div class="flex gap-2">
                <select name="calendar_type" id="calendarType" class="input-box w-[120px] text-center text-black font-medium">
                    <option value="ì–‘ë ¥">ì–‘ë ¥</option>
                    <option value="ìŒë ¥">ìŒë ¥</option>
                    <option value="ìŒë ¥(ìœ¤ë‹¬)">ìŒë ¥(ìœ¤ë‹¬)</option>
                </select>
                <input type="text" name="birth_date" id="birthDate" maxlength="10" placeholder="1990/01/15" class="input-box flex-1 text-center" oninput="maskDate(this)" required>
                <input type="text" name="birth_time" id="birthTime" maxlength="5" placeholder="14:30" class="input-box w-[100px] text-center" oninput="maskTime(this)" required>
            </div>
            
            <input type="hidden" name="use_yajas_i" id="hiddenYajas" value="false">
            <div class="flex gap-6 pt-1">
                <div onclick="handleToggle('timeUnknown')" class="toggle-btn" id="toggle_timeUnknown">
                    <div class="circle"></div>
                    <span>ì‹œê°„ ëª¨ë¦„</span>
                </div>
            </div>
        </div>

        <div class="space-y-3">
            <label class="font-bold text-[17px] text-[#333]">íƒœì–´ë‚œ ë„ì‹œ</label>
            <input type="hidden" name="location" id="hiddenLocation" value="">
            <div onclick="openCitySheet()" id="displayLocation" class="input-box cursor-pointer flex justify-between items-center bg-white">
                <span id="locText" class="text-[#b5b5b5]">ì‹œêµ° ë‹¨ìœ„ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”</span>
                <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
        </div>

        <div class="bg-purple-50 rounded-2xl p-4 border border-purple-100">
            <p class="text-sm text-purple-700 leading-relaxed">
                <span class="font-bold">âœ¨ í‰ìƒìš´ì„¸ ì•ˆë‚´</span><br>
                ì´ìš´, ì¬ë¬¼ìš´, ì• ì •ìš´, ê²°í˜¼ìš´, ì§ì—…ìš´, ì‚¬ì—…ìš´, ëŒ€ì¸ìš´, ê±´ê°•ìš´ê¹Œì§€ 9ê°€ì§€ ì˜ì—­ì˜ ìƒì„¸í•œ ìš´ì„¸ë¥¼ AIê°€ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.
            </p>
        </div>

        <button type="button" onclick="submitLifetime()" class="w-full gradient-btn text-white py-4.5 rounded-full font-bold text-[18px] mt-6 shadow-lg transition-all hover:shadow-xl">
            í‰ìƒìš´ì„¸ ë³´ê¸° ğŸŒŸ
        </button>
    </form>

    <div id="sheetOverlay" onclick="closeCitySheet()" class="sheet-overlay fixed inset-0 bg-black/40 z-40"></div>
    <div id="citySheet" class="fixed bottom-0 left-0 right-0 bg-white z-50 rounded-t-[36px] p-7 h-[85vh] flex flex-col shadow-2xl">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-8"></div>
        <div class="relative mb-4">
            <input type="text" id="citySearch" oninput="searchCity(this.value)" placeholder="ë„ì‹œëª… ë˜ëŠ” êµ° ë‹¨ìœ„ ê²€ìƒ‰ (ì˜ˆ: ì–‘í‰)" class="input-box w-full pr-12 !text-black border-[#e5e5e5]">
            <svg class="absolute right-4 top-3.5 w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
        <div id="cityResults" class="flex-1 overflow-y-auto space-y-1 pt-4 border-t border-gray-100 no-scrollbar">
            <p class="text-center py-20 text-[#999]">ì „êµ­ 160ì—¬ ê°œ ì‹œÂ·êµ° ê²€ìƒ‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <script>
        let formState = { gender: 'F', timeUnknown: false, location: '' };
        const KOREA_CITIES = {{ cities|tojson }};

        function maskDate(obj) {
            let val = obj.value.replace(/\D/g, "");
            let res = "";
            if (val.length > 0) {
                res += val.substring(0, 4);
                if (val.length >= 4) { res += "/"; if (val.length > 4) { res += val.substring(4, 6); if (val.length >= 6) { res += "/"; if (val.length > 6) res += val.substring(6, 8); } } }
            }
            obj.value = res;
        }

        function maskTime(obj) {
            let val = obj.value.replace(/\D/g, "");
            let res = "";
            if (val.length > 0) { res += val.substring(0, 2); if (val.length >= 2) { res += ":"; if (val.length > 2) res += val.substring(2, 4); } }
            obj.value = res;
        }

        function handleToggle(key) {
            formState[key] = !formState[key];
            updateToggleUI(key);
            const timeInput = document.getElementById('birthTime');
            timeInput.style.opacity = formState.timeUnknown ? "0.3" : "1";
            timeInput.disabled = formState.timeUnknown;
            if(formState.timeUnknown) timeInput.value = "12:00";
        }

        function updateToggleUI(key) {
            const el = document.getElementById('toggle_' + key);
            if (formState[key]) el.classList.add('active');
            else el.classList.remove('active');
        }

        function searchCity(val) {
            const results = document.getElementById('cityResults');
            if (!val) { results.innerHTML = '<p class="text-center py-20 text-[#999]">ì „êµ­ ë„ì‹œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>'; return; }
            const filtered = KOREA_CITIES.filter(city => city.includes(val));
            results.innerHTML = filtered.map(city => `<div onclick="selectCity('${city}')" class="py-4 px-2 text-[17px] text-[#333] cursor-pointer hover:bg-purple-50 border-b border-gray-100">${city}</div>`).join('');
            if (filtered.length === 0) results.innerHTML = '<p class="text-center py-20 text-[#999]">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        function selectCity(city) {
            formState.location = city;
            document.getElementById('hiddenLocation').value = city;
            const locText = document.getElementById('locText');
            locText.innerText = city; locText.classList.replace('text-[#b5b5b5]', 'text-black');
            closeCitySheet();
        }

        function setGender(g) {
            formState.gender = g;
            document.getElementById('hiddenGender').value = g;
            document.getElementById('btnF').className = g === 'F' ? 'flex-1 py-3.5 rounded-2xl border-[1.5px] border-purple-400 font-bold text-[16px] bg-purple-50 text-purple-600' : 'flex-1 py-3.5 rounded-2xl border border-gray-200 text-gray-400 text-[16px]';
            document.getElementById('btnM').className = g === 'M' ? 'flex-1 py-3.5 rounded-2xl border-[1.5px] border-purple-400 font-bold text-[16px] bg-purple-50 text-purple-600' : 'flex-1 py-3.5 rounded-2xl border border-gray-200 text-gray-400 text-[16px]';
        }

        function openCitySheet() { document.getElementById('sheetOverlay').classList.add('show'); document.getElementById('citySheet').classList.add('show'); setTimeout(() => document.getElementById('citySearch').focus(), 300); }
        function closeCitySheet() { document.getElementById('sheetOverlay').classList.remove('show'); document.getElementById('citySheet').classList.remove('show'); }

        function submitLifetime() {
            const date = document.getElementById('birthDate').value;
            const time = document.getElementById('birthTime').value;
            const loc = formState.location;

            if(!date || date.length < 10) return alert("ìƒë…„ì›”ì¼ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš” (YYYY/MM/DD).");
            if(!formState.timeUnknown && (!time || time.length < 5)) return alert("íƒœì–´ë‚œ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if(!loc) return alert("íƒœì–´ë‚œ ë„ì‹œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

            document.getElementById('lifetimeForm').submit();
        }
    </script>
</body>
</html>
