<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í¬ìŠ¤í…”ëŸ¬ ë§Œì„¸ë ¥ 2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f9f9f9; -webkit-tap-highlight-color: transparent; }
        .input-box { border: 1.5px solid #dcdcdc; border-radius: 14px; padding: 12px; font-size: 16px; color: #333; transition: all 0.2s; background: white; }
        .input-box:focus { border-color: #333; outline: none; }
        .toggle-btn { display: flex; align-items: center; gap: 8px; cursor: pointer; color: #444; font-size: 16px; user-select: none; padding: 4px 0; }
        .circle { width: 22px; height: 22px; border: 1.5px solid #dcdcdc; border-radius: 50%; position: relative; transition: all 0.2s; background: white; flex-shrink: 0; }
        .toggle-btn.active .circle { border-color: #4a4542; background-color: #4a4542; }
        .toggle-btn.active .circle::after { content: ''; position: absolute; width: 8px; height: 8px; background: white; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        #citySheet { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #citySheet.show { transform: translateY(0); }
        .sheet-overlay { opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .sheet-overlay.show { opacity: 1; pointer-events: auto; }
        .time-modal-content { background-color: #4a4542; color: white; border-radius: 28px; width: 92%; max-width: 400px; }
        .time-table { border-collapse: collapse; width: 100%; font-size: 14px; color: #ececec; }
        .time-table th, .time-table td { border: 1px solid #635e5b; padding: 10px 8px; text-align: center; }
        .time-table th { background-color: #5a5552; color: #cfcfcf; font-weight: 500; }
    </style>
</head>
<body class="flex flex-col items-center p-4">

    <form id="sajuForm" action="/analyze_web" method="POST" class="w-full max-w-md bg-white rounded-[32px] shadow-sm p-7 space-y-8 mt-4">
        <h1 class="text-center font-bold text-[20px] mb-2">í¬ìŠ¤í…”ëŸ¬ ë§Œì„¸ë ¥ 2.2 ğŸŒŸ</h1>

        <div class="space-y-3">
            <label class="font-bold text-[17px] text-[#333]">ì´ë¦„</label>
            <input type="text" name="name" id="name" placeholder="ìµœëŒ€ 12ê¸€ì ì´ë‚´" class="w-full border-0 border-b border-gray-200 py-3 text-[16px] focus:border-black outline-none transition-colors" required>
        </div>

        <div class="space-y-3">
            <label class="font-bold text-[17px] text-[#333]">ì„±ë³„</label>
            <input type="hidden" name="gender" id="hiddenGender" value="F">
            <div class="flex gap-2">
                <button type="button" onclick="setGender('F')" id="btnF" class="flex-1 py-3.5 rounded-2xl border-[1.5px] border-[#333] font-bold text-[16px] bg-white transition-all">ì—¬ì</button>
                <button type="button" onclick="setGender('M')" id="btnM" class="flex-1 py-3.5 rounded-2xl border border-gray-200 text-gray-400 text-[16px] transition-all">ë‚¨ì</button>
            </div>
        </div>

        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <label class="font-bold text-[17px] text-[#333]">ìƒë…„ì›”ì¼ì‹œ</label>
                <div onclick="toggleTimeModal(true)" class="text-[15px] text-[#666] cursor-pointer flex items-center gap-1">
                    12ê°„ì§€ ì‹œê°„í‘œ <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
            </div>
            
            <div class="flex gap-2">
                <select name="calendar_type" id="calendarType" class="input-box w-[120px] text-center text-black font-medium">
                    <option value="ì–‘ë ¥">ì–‘ë ¥</option>
                    <option value="ìŒë ¥">ìŒë ¥</option>
                    <option value="ìŒë ¥(ìœ¤ë‹¬)">ìŒë ¥(ìœ¤ë‹¬)</option>
                </select>
                <input type="text" name="birth_date" id="birthDate" maxlength="10" placeholder="1981/03/04" class="input-box flex-1 text-center" oninput="maskDate(this)" required>
                <input type="text" name="birth_time" id="birthTime" maxlength="5" placeholder="14:01" class="input-box w-[100px] text-center" oninput="maskTime(this)" required>
            </div>
            
            <input type="hidden" name="use_yajas_i" id="hiddenYajas" value="false">
            <div class="flex gap-6 pt-1">
                <div onclick="handleToggle('timeUnknown')" class="toggle-btn" id="toggle_timeUnknown">
                    <div class="circle"></div>
                    <span>ì‹œê°„ ëª¨ë¦„</span>
                </div>
                <div onclick="handleToggle('yajas')" class="toggle-btn" id="toggle_yajas">
                    <div class="circle"></div>
                    <span>ì•¼ìì‹œ/ì¡°ìì‹œ ì ìš©</span>
                </div>
            </div>
        </div>

        <div class="space-y-3">
            <label class="font-bold text-[17px] text-[#333]">íƒœì–´ë‚œ ë„ì‹œ</label>
            <input type="hidden" name="location" id="hiddenLocation" value="">
            <div onclick="openCitySheet()" id="displayLocation" class="input-box cursor-pointer flex justify-between items-center bg-white">
                <span id="locText" class="text-[#b5b5b5]">ì‹œêµ° ë‹¨ìœ„ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”</span>
                <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
        </div>

        <button type="button" onclick="submitSaju()" class="w-full bg-[#333] text-white py-4.5 rounded-full font-bold text-[18px] mt-6">ë§Œì„¸ë ¥ ë³´ëŸ¬ê°€ê¸°</button>
    </form>

    <div id="sheetOverlay" onclick="closeCitySheet()" class="sheet-overlay fixed inset-0 bg-black/40 z-40"></div>
    <div id="citySheet" class="fixed bottom-0 left-0 right-0 bg-white z-50 rounded-t-[36px] p-7 h-[85vh] flex flex-col shadow-2xl">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-8"></div>
        <div class="relative mb-4">
            <input type="text" id="citySearch" oninput="searchCity(this.value)" placeholder="ë„ì‹œëª… ë˜ëŠ” êµ° ë‹¨ìœ„ ê²€ìƒ‰ (ì˜ˆ: ì–‘í‰)" class="input-box w-full pr-12 !text-black border-[#e5e5e5]">
            <svg class="absolute right-4 top-3.5 w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
        <div id="cityResults" class="flex-1 overflow-y-auto space-y-1 pt-4 border-t border-gray-100 no-scrollbar">
            <p class="text-center py-20 text-[#999]">ì „êµ­ 160ì—¬ ê°œ ì‹œÂ·êµ° ê²€ìƒ‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <div id="timeModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
        <div onclick="toggleTimeModal(false)" class="absolute inset-0 bg-black/60"></div>
        <div class="time-modal-content relative p-7 shadow-2xl overflow-y-auto max-h-[80vh] no-scrollbar">
            <h2 class="text-[20px] font-bold mb-4">12ê°„ì§€ ì‹œê°„í‘œ (ì§€ì—­ì‹œ ë³´ì • ì „)</h2>
            <table class="time-table">
                <thead><tr><th>ê°„ì§€</th><th>ì‹œê°„ ë²”ìœ„</th></tr></thead>
                <tbody>
                    <tr><td>ìì‹œ(å­)</td><td>23:30 ~ 01:30</td></tr>
                    <tr><td>ì¶•ì‹œ(ä¸‘)</td><td>01:30 ~ 03:30</td></tr>
                    <tr><td>ì¸ì‹œ(å¯…)</td><td>03:30 ~ 05:30</td></tr>
                    <tr><td>ë¬˜ì‹œ(å¯)</td><td>05:30 ~ 07:30</td></tr>
                    <tr><td>ì§„ì‹œ(è¾°)</td><td>07:30 ~ 09:30</td></tr>
                    <tr><td>ì‚¬ì‹œ(å·³)</td><td>09:30 ~ 11:30</td></tr>
                    <tr><td>ì˜¤ì‹œ(åˆ)</td><td>11:30 ~ 13:30</td></tr>
                    <tr><td>ë¯¸ì‹œ(æœª)</td><td>13:30 ~ 15:30</td></tr>
                    <tr><td>ì‹ ì‹œ(ç”³)</td><td>15:30 ~ 17:30</td></tr>
                    <tr><td>ìœ ì‹œ(é…‰)</td><td>17:30 ~ 19:30</td></tr>
                    <tr><td>ìˆ ì‹œ(æˆŒ)</td><td>19:30 ~ 21:30</td></tr>
                    <tr><td>í•´ì‹œ(äº¥)</td><td>21:30 ~ 23:30</td></tr>
                </tbody>
            </table>
            <p class="text-[12px] text-gray-400 mt-4 leading-relaxed">* ë³¸ ë§Œì„¸ë ¥ì€ ì§€ì—­ë³„ ì‹œì°¨ë¥¼ ìë™ìœ¼ë¡œ ê³„ì‚°í•˜ì—¬ ì ìš©í•©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <script>
        let sajuState = { gender: 'F', timeUnknown: false, yajas: false, location: '' };

        // ì „êµ­ 162ê°œ ì‹œÂ·êµ° í†µí•© ë¦¬ìŠ¤íŠ¸ (CITY_DATAì™€ 100% ì¼ì¹˜)
        const KOREA_CITIES = {{ cities|tojson }};

        function maskDate(obj) {
            let val = obj.value.replace(/\D/g, "");
            let res = "";
            if (val.length > 0) {
                res += val.substring(0, 4);
                if (val.length >= 4) { res += "/"; if (val.length > 4) { res += val.substring(4, 6); if (val.length >= 6) { res += "/"; if (val.length > 6) res += val.substring(6, 8); } } }
            }
            obj.value = res;
        }

        function maskTime(obj) {
            let val = obj.value.replace(/\D/g, "");
            let res = "";
            if (val.length > 0) { res += val.substring(0, 2); if (val.length >= 2) { res += ":"; if (val.length > 2) res += val.substring(2, 4); } }
            obj.value = res;
        }

        function handleToggle(key) {
            const otherKey = (key === 'timeUnknown') ? 'yajas' : 'timeUnknown';
            const isTurningOn = !sajuState[key];
            sajuState[key] = isTurningOn;
            updateToggleUI(key);

            if (isTurningOn) {
                sajuState[otherKey] = false;
                updateToggleUI(otherKey);
            }

            document.getElementById('hiddenYajas').value = sajuState.yajas;
            const timeInput = document.getElementById('birthTime');
            timeInput.style.opacity = sajuState.timeUnknown ? "0.3" : "1";
            timeInput.disabled = sajuState.timeUnknown;
            if(sajuState.timeUnknown) timeInput.value = "12:00"; 
        }

        function updateToggleUI(key) {
            const el = document.getElementById('toggle_' + key);
            if (sajuState[key]) el.classList.add('active');
            else el.classList.remove('active');
        }

        function searchCity(val) {
            const results = document.getElementById('cityResults');
            if (!val) { results.innerHTML = '<p class="text-center py-20 text-[#999]">ì „êµ­ ë„ì‹œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>'; return; }
            const filtered = KOREA_CITIES.filter(city => city.includes(val));
            results.innerHTML = filtered.map(city => `<div onclick="selectCity('${city}')" class="py-4 px-2 text-[17px] text-[#333] cursor-pointer hover:bg-gray-50 border-b border-gray-100">${city}</div>`).join('');
            if (filtered.length === 0) results.innerHTML = '<p class="text-center py-20 text-[#999]">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        function selectCity(city) {
            sajuState.location = city;
            document.getElementById('hiddenLocation').value = city; 
            const locText = document.getElementById('locText');
            locText.innerText = city; locText.classList.replace('text-[#b5b5b5]', 'text-black');
            closeCitySheet();
        }

        function setGender(g) {
            sajuState.gender = g;
            document.getElementById('hiddenGender').value = g; 
            document.getElementById('btnF').className = g === 'F' ? 'flex-1 py-3.5 rounded-2xl border-[1.5px] border-[#333] font-bold text-[16px] bg-white' : 'flex-1 py-3.5 rounded-2xl border border-gray-200 text-gray-400 text-[16px]';
            document.getElementById('btnM').className = g === 'M' ? 'flex-1 py-3.5 rounded-2xl border-[1.5px] border-[#333] font-bold text-[16px] bg-white' : 'flex-1 py-3.5 rounded-2xl border border-gray-200 text-gray-400 text-[16px]';
        }

        function toggleTimeModal(show) { document.getElementById('timeModal').classList.toggle('hidden', !show); }
        function openCitySheet() { document.getElementById('sheetOverlay').classList.add('show'); document.getElementById('citySheet').classList.add('show'); setTimeout(() => document.getElementById('citySearch').focus(), 300); }
        function closeCitySheet() { document.getElementById('sheetOverlay').classList.remove('show'); document.getElementById('citySheet').classList.remove('show'); }

        function submitSaju() {
            const name = document.getElementById('name').value;
            const date = document.getElementById('birthDate').value;
            const time = document.getElementById('birthTime').value;
            const loc = sajuState.location;

            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if(!date || date.length < 10) return alert("ìƒë…„ì›”ì¼ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš” (YYYY/MM/DD).");
            if(!sajuState.timeUnknown && (!time || time.length < 5)) return alert("íƒœì–´ë‚œ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if(!loc) return alert("íƒœì–´ë‚œ ë„ì‹œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

            document.getElementById('sajuForm').submit();
        }
    </script>
</body>
</html>