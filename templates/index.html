<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>포스텔러 만세력 2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f9f9f9; -webkit-tap-highlight-color: transparent; }
        .input-box { border: 1.5px solid #dcdcdc; border-radius: 14px; padding: 12px; font-size: 16px; color: #333; transition: all 0.2s; background: white; }
        .input-box:focus { border-color: #333; outline: none; }
        .toggle-btn { display: flex; align-items: center; gap: 8px; cursor: pointer; color: #444; font-size: 16px; user-select: none; padding: 4px 0; }
        .circle { width: 22px; height: 22px; border: 1.5px solid #dcdcdc; border-radius: 50%; position: relative; transition: all 0.2s; background: white; flex-shrink: 0; }
        .toggle-btn.active .circle { border-color: #4a4542; background-color: #4a4542; }
        .toggle-btn.active .circle::after { content: ''; position: absolute; width: 8px; height: 8px; background: white; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        #citySheet { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #citySheet.show { transform: translateY(0); }
        .sheet-overlay { opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .sheet-overlay.show { opacity: 1; pointer-events: auto; }
        .time-modal-content { background-color: #4a4542; color: white; border-radius: 28px; width: 92%; max-width: 400px; }
        .time-table { border-collapse: collapse; width: 100%; font-size: 14px; color: #ececec; }
        .time-table th, .time-table td { border: 1px solid #635e5b; padding: 10px 8px; text-align: center; }
        .time-table th { background-color: #5a5552; color: #cfcfcf; font-weight: 500; }
    </style>
</head>
<body class="flex flex-col items-center p-4">
    {% if error %}
<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
    <strong class="font-bold">에러 발생:</strong>
    <span class="block sm:inline">{{ error }}</span>
</div>
{% endif %}

    <form id="sajuForm" action="/analyze_web" method="POST" class="w-full max-w-md bg-white rounded-[32px] shadow-sm p-7 space-y-8 mt-4">
        <h1 class="text-center font-bold text-[20px] mb-2">만세력</h1>

        <div class="space-y-3">
            <label class="font-bold text-[17px] text-[#333]">이름</label>
            <input type="text" name="name" id="name" placeholder="최대 12글자 이내" class="w-full border-0 border-b border-gray-200 py-3 text-[16px] focus:border-black outline-none transition-colors" required>
        </div>

        <div class="space-y-3">
            <label class="font-bold text-[17px] text-[#333]">성별</label>
            <input type="hidden" name="gender" id="hiddenGender" value="F">
            <div class="flex gap-2">
                <button type="button" onclick="setGender('F')" id="btnF" class="flex-1 py-3.5 rounded-2xl border-[1.5px] border-[#333] font-bold text-[16px] bg-white transition-all">여자</button>
                <button type="button" onclick="setGender('M')" id="btnM" class="flex-1 py-3.5 rounded-2xl border border-gray-200 text-gray-400 text-[16px] transition-all">남자</button>
            </div>
        </div>

        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <label class="font-bold text-[17px] text-[#333]">생년월일시</label>
                <div onclick="toggleTimeModal(true)" class="text-[15px] text-[#666] cursor-pointer flex items-center gap-1">
                    12간지 시간표 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
            </div>
            
            <div class="flex gap-2">
                <select name="calendar_type" id="calendarType" class="input-box w-[120px] text-center text-black font-medium">
                    <option value="양력">양력</option>
                    <option value="음력">음력</option>
                    <option value="음력(윤달)">음력(윤달)</option>
                </select>
                <input type="text" name="birth_date" id="birthDate" maxlength="10" placeholder="1981/03/04" class="input-box flex-1 text-center" oninput="maskDate(this)" required>
                <input type="text" name="birth_time" id="birthTime" maxlength="5" placeholder="14:01" class="input-box w-[100px] text-center" oninput="maskTime(this)" required>
            </div>
            
            <input type="hidden" name="use_yajas_i" id="hiddenYajas" value="false">
            <div class="flex gap-6 pt-1">
                <div onclick="handleToggle('timeUnknown')" class="toggle-btn" id="toggle_timeUnknown">
                    <div class="circle"></div>
                    <span>시간 모름</span>
                </div>
                <div onclick="handleToggle('yajas')" class="toggle-btn" id="toggle_yajas">
                    <div class="circle"></div>
                    <span>야자시/조자시 적용</span>
                </div>
            </div>
        </div>

        <div class="space-y-3">
            <label class="font-bold text-[17px] text-[#333]">태어난 도시</label>
            <input type="hidden" name="location" id="hiddenLocation" value="">
            <div onclick="openCitySheet()" id="displayLocation" class="input-box cursor-pointer flex justify-between items-center bg-white">
                <span id="locText" class="text-[#b5b5b5]">시군 단위로 검색하세요</span>
                <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
        </div>

        <button type="button" onclick="submitSaju()" class="w-full bg-[#333] text-white py-4.5 rounded-full font-bold text-[18px] mt-6">만세력 보러가기</button>
    </form>

    <div id="sheetOverlay" onclick="closeCitySheet()" class="sheet-overlay fixed inset-0 bg-black/40 z-40"></div>
    <div id="citySheet" class="fixed bottom-0 left-0 right-0 bg-white z-50 rounded-t-[36px] p-7 h-[85vh] flex flex-col shadow-2xl">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-8"></div>
        <div class="relative mb-4">
            <input type="text" id="citySearch" oninput="searchCity(this.value)" placeholder="도시명 또는 군 단위 검색 (예: 양평)" class="input-box w-full pr-12 !text-black border-[#e5e5e5]">
            <svg class="absolute right-4 top-3.5 w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
        <div id="cityResults" class="flex-1 overflow-y-auto space-y-1 pt-4 border-t border-gray-100 no-scrollbar">
            <p class="text-center py-20 text-[#999]">전국 160여 개 시·군 검색이 가능합니다.</p>
        </div>
    </div>

    <div id="timeModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
        <div onclick="toggleTimeModal(false)" class="absolute inset-0 bg-black/60"></div>
        <div class="time-modal-content relative p-7 shadow-2xl overflow-y-auto max-h-[80vh] no-scrollbar">
            <h2 class="text-[20px] font-bold mb-4">12간지 시간표 (지역시 보정 전)</h2>
            <table class="time-table">
                <thead><tr><th>간지</th><th>시간 범위</th></tr></thead>
                <tbody>
                    <tr><td>자시(子)</td><td>23:30 ~ 01:30</td></tr>
                    <tr><td>축시(丑)</td><td>01:30 ~ 03:30</td></tr>
                    <tr><td>인시(寅)</td><td>03:30 ~ 05:30</td></tr>
                    <tr><td>묘시(卯)</td><td>05:30 ~ 07:30</td></tr>
                    <tr><td>진시(辰)</td><td>07:30 ~ 09:30</td></tr>
                    <tr><td>사시(巳)</td><td>09:30 ~ 11:30</td></tr>
                    <tr><td>오시(午)</td><td>11:30 ~ 13:30</td></tr>
                    <tr><td>미시(未)</td><td>13:30 ~ 15:30</td></tr>
                    <tr><td>신시(申)</td><td>15:30 ~ 17:30</td></tr>
                    <tr><td>유시(酉)</td><td>17:30 ~ 19:30</td></tr>
                    <tr><td>술시(戌)</td><td>19:30 ~ 21:30</td></tr>
                    <tr><td>해시(亥)</td><td>21:30 ~ 23:30</td></tr>
                </tbody>
            </table>
            <p class="text-[12px] text-gray-400 mt-4 leading-relaxed">* 본 만세력은 지역별 시차를 자동으로 계산하여 적용합니다.</p>
        </div>
    </div>

    <script>
        let sajuState = { gender: 'F', timeUnknown: false, yajas: false, location: '' };

        // 전국 162개 시·군 통합 리스트 (CITY_DATA와 100% 일치)
        const KOREA_CITIES = {{ cities|tojson }};

        function maskDate(obj) {
            let val = obj.value.replace(/\D/g, "");
            let res = "";
            if (val.length > 0) {
                res += val.substring(0, 4);
                if (val.length >= 4) { res += "/"; if (val.length > 4) { res += val.substring(4, 6); if (val.length >= 6) { res += "/"; if (val.length > 6) res += val.substring(6, 8); } } }
            }
            obj.value = res;
        }

        function maskTime(obj) {
            let val = obj.value.replace(/\D/g, "");
            let res = "";
            if (val.length > 0) { res += val.substring(0, 2); if (val.length >= 2) { res += ":"; if (val.length > 2) res += val.substring(2, 4); } }
            obj.value = res;
        }

        function handleToggle(key) {
            const otherKey = (key === 'timeUnknown') ? 'yajas' : 'timeUnknown';
            const isTurningOn = !sajuState[key];
            sajuState[key] = isTurningOn;
            updateToggleUI(key);

            if (isTurningOn) {
                sajuState[otherKey] = false;
                updateToggleUI(otherKey);
            }

            document.getElementById('hiddenYajas').value = sajuState.yajas;
            const timeInput = document.getElementById('birthTime');
            timeInput.style.opacity = sajuState.timeUnknown ? "0.3" : "1";
            timeInput.disabled = sajuState.timeUnknown;
            if(sajuState.timeUnknown) timeInput.value = "12:00"; 
        }

        function updateToggleUI(key) {
            const el = document.getElementById('toggle_' + key);
            if (sajuState[key]) el.classList.add('active');
            else el.classList.remove('active');
        }

        function searchCity(val) {
            const results = document.getElementById('cityResults');
            if (!val) { results.innerHTML = '<p class="text-center py-20 text-[#999]">전국 도시명을 입력해주세요.</p>'; return; }
            const filtered = KOREA_CITIES.filter(city => city.includes(val));
            results.innerHTML = filtered.map(city => `<div onclick="selectCity('${city}')" class="py-4 px-2 text-[17px] text-[#333] cursor-pointer hover:bg-gray-50 border-b border-gray-100">${city}</div>`).join('');
            if (filtered.length === 0) results.innerHTML = '<p class="text-center py-20 text-[#999]">검색 결과가 없습니다.</p>';
        }

        function selectCity(city) {
            sajuState.location = city;
            document.getElementById('hiddenLocation').value = city; 
            const locText = document.getElementById('locText');
            locText.innerText = city; locText.classList.replace('text-[#b5b5b5]', 'text-black');
            closeCitySheet();
        }

        function setGender(g) {
            sajuState.gender = g;
            document.getElementById('hiddenGender').value = g; 
            document.getElementById('btnF').className = g === 'F' ? 'flex-1 py-3.5 rounded-2xl border-[1.5px] border-[#333] font-bold text-[16px] bg-white' : 'flex-1 py-3.5 rounded-2xl border border-gray-200 text-gray-400 text-[16px]';
            document.getElementById('btnM').className = g === 'M' ? 'flex-1 py-3.5 rounded-2xl border-[1.5px] border-[#333] font-bold text-[16px] bg-white' : 'flex-1 py-3.5 rounded-2xl border border-gray-200 text-gray-400 text-[16px]';
        }

        function toggleTimeModal(show) { document.getElementById('timeModal').classList.toggle('hidden', !show); }
        function openCitySheet() { document.getElementById('sheetOverlay').classList.add('show'); document.getElementById('citySheet').classList.add('show'); setTimeout(() => document.getElementById('citySearch').focus(), 300); }
        function closeCitySheet() { document.getElementById('sheetOverlay').classList.remove('show'); document.getElementById('citySheet').classList.remove('show'); }

        function submitSaju() {
            const name = document.getElementById('name').value;
            const date = document.getElementById('birthDate').value;
            const time = document.getElementById('birthTime').value;
            const loc = sajuState.location;

            if(!name) return alert("이름을 입력해주세요.");
            if(!date || date.length < 10) return alert("생년월일을 정확히 입력해주세요 (YYYY/MM/DD).");
            if(!sajuState.timeUnknown && (!time || time.length < 5)) return alert("태어난 시간을 입력해주세요.");
            if(!loc) return alert("태어난 도시를 선택해주세요.");

            document.getElementById('sajuForm').submit();
        }
    </script>
</body>
</html>