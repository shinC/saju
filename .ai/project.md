# 프로젝트 컨텍스트 (Project Context)

## 프로젝트 개요

**사주 만세력 앱** - 포스텔러/점신 스타일의 상용 사주풀이 앱

### 핵심 목표
1. 정확한 만세력 기반 사주 분석 (지역시 보정, 역사적 표준시 반영)
2. 자연스러운 한국어 운세 (사주 전문용어 노출 금지)
3. 상용 앱 수준의 UI/UX (포스텔러 벤치마킹)

---

## 핵심 설계 원칙

### 1. 사주 전문용어 노출 금지
- **내부**: 십성, 오행, 신살 등 전문용어로 계산
- **출력**: "오늘은 집중력이 좋은 날입니다" 같은 자연스러운 표현
- **예시**: "정관이 강하다" ❌ → "리더십을 발휘하기 좋은 날" ✅

### 2. 시드 기반 일관성
```
같은 생년월일 + 같은 날짜 = 항상 같은 운세
```
- 사용자가 같은 날 다시 조회해도 동일한 결과
- hashlib으로 시드 생성 → random.seed() 고정

### 3. 템플릿 조합 방식
운세는 단일 문장이 아니라 여러 템플릿을 조합:
```
[점수 레벨 템플릿] + [십성 기반 문장] + [상황별 조언]
```
약 1,930개 템플릿으로 다양한 결과 생성

---

## 주요 모듈 역할

| 파일 | 역할 | 라인수 |
|------|------|--------|
| `saju_engine.py` | 핵심 사주 계산 엔진 | ~1,400 |
| `saju_constants.py` | 모든 상수 정의 | ~500 |
| `fortune_generator.py` | 운세 생성 로직 | ~600 |
| `fortune_templates/*.py` | 운세 템플릿 (8개 분야) | ~1,930개 |
| `FortuneBridge.py` | 일주별 성격/행운아이템 | ~100 |
| `main.py` | FastAPI 서버 + 라우트 | ~350 |

---

## 데이터 구조

### manse_data.json (만세력 DB)
```json
{
  "19900115": {
    "year": "庚午",    // 년주
    "month": "丁丑",   // 월주
    "day": "甲子",     // 일주
    "ly": 1989,        // 음력 년
    "lm": 12,          // 음력 월
    "ld": 19,          // 음력 일
    "ls": false        // 윤달 여부
  }
}
```

### term_data.json (절기 DB)
```json
{
  "2026": {
    "입춘": "2026-02-04T04:52:00",
    "우수": "2026-02-18T14:36:00",
    ...
  }
}
```

### ilju_data.json (60일주 성격 데이터)
```json
{
  "甲子": {
    "title": "큰 바다를 품은 소나무",
    "mbti": "ENTJ",
    "lucky_color": "청색",
    "lucky_number": "3, 8",
    ...
  }
}
```

---

## saju_engine.analyze() 반환값

```python
{
    # 기본 정보
    "name": "홍길동",
    "birth": "1990-01-15 14:30",
    "gender": "M",
    "ilju": "甲子",
    
    # 사주 4기둥
    "pillars": [
        {
            "gan": "庚", "gan_kor": "경", "gan_elem": "금",
            "ji": "午", "ji_kor": "오", "ji_elem": "화",
            "t_gan": "편관", "t_ji": "정관",  # 십성
            "unseong": "장생",                 # 12운성
            "sinsal_12": "역마",               # 12신살
            "jijangan": "丁己",                # 지장간
        },
        # ... 3개 더 (월, 일, 시)
    ],
    
    # 오행 분석
    "scores": {"목": 2, "화": 3, "토": 1, "금": 2, "수": 2},
    "power": 55,           # 신강약 점수 (0-100)
    "status": "신강",
    "representative_elem": "화",
    "representative_tendency": "정관",
    
    # 용신
    "yongsin_detail": {
        "main_yongsin": "수(水)",
        "johoo_name": "화(火)",
        "johoo_desc": "겨울 태생으로 따뜻함이 필요합니다."
    },
    
    # 운로
    "daeun_list": [...],        # 대운 리스트
    "current_trace": {          # 현재 운
        "daeun": {...},
        "saeun": {...},
        "wolun": {...}
    },
    
    # 상호작용
    "interactions": {
        "천간합": [...],
        "지지육합": [...],
        "지지충": [...],
        "공망": [...],
        ...
    }
}
```

---

## 운세 생성 흐름

```
1. 사용자 입력
   ↓
2. SajuEngine.analyze() → 사주 분석 결과
   ↓
3. FortuneGenerator.generate_daily_fortune()
   - 점수 계산 (합/충/형 기반)
   - 레벨 결정 (excellent/good/average/caution/difficult)
   - 템플릿 선택 (시드 고정)
   - 문장 조합
   ↓
4. 운세 JSON 반환
   ↓
5. fortune_result.html 렌더링
```

---

## 작업 시 주의사항

### DO
- 기존 템플릿 스타일 따르기 (자연스러운 한국어)
- 점수 계산 로직 이해 후 수정
- 새 기능 추가 시 이 문서 업데이트

### DON'T
- 사주 전문용어를 사용자에게 직접 노출
- 시드 로직 변경 (일관성 깨짐)
- saju_engine.py의 핵심 계산 로직 임의 변경

---

## 다음 가능한 작업들

- [ ] 주간/월간 운세
- [ ] 궁합 분석
- [ ] 프리미엄 AI 해석 (OpenAI 연동)
- [ ] 캐싱/DB 연동 (성능 최적화)
- [ ] 사용자 인증/결제 시스템
